name: éƒµä»¶å‚™ä»½

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: '18'
    - run: npm install xlsx
    - run: |
        echo "DATE=$(TZ=Asia/Taipei date +'%Y-%m-%d')" >> $GITHUB_ENV
    - run: |
        cat > backup.js << 'EOF'
        const fs = require('fs');
        const XLSX = require('xlsx');
        const html = fs.readFileSync('index.html', 'utf8');
        const match = html.match(/const initialTrials = (\[[\s\S]*?\]);/);
        if (match) {
          const trials = JSON.parse(match[1]);
          const ws = XLSX.utils.json_to_sheet(trials.map(t => ({
            'ID': t.id, 'ç™Œç—‡é¡å‹': t.cancerType, 'è©¦é©—åç¨±': t.studyTitle,
            'ä»£è™Ÿ': t.code, 'æœŸåˆ¥': t.phase, 'è´ŠåŠ©å•†': t.sponsor,
            'ç›®æ¨™äººæ•¸': t.targetNum, 'å·²æ”¶æ¡ˆ': t.enrolled,
            'ä¸»æŒäºº': t.pi, 'ç ”ç©¶è­·å£«': t.nurse, 'é›»è©±': t.phone,
            'ç‹€æ…‹': t.status, 'æ”¶æ¡ˆæ¢ä»¶': t.inclusion || '',
            'æ’é™¤æ¢ä»¶': t.exclusion || ''
          })));
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'è‡¨åºŠè©¦é©—');
          XLSX.writeFile(wb, `å‚™ä»½_${process.env.DATE}.xlsx`);
        }
        EOF
    - run: node backup.js
    - uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: è‡¨åºŠè©¦é©—å‚™ä»½ ${{ env.DATE }}
        to: coingate@gmail.com
        from: å‚™ä»½ <backup@system.local>
        body: å‚™ä»½å®Œæˆ
        attachments: å‚™ä»½_${{ env.DATE }}.xlsx
```

---

### æ­¥é©Ÿ 4ï¼šå„²å­˜

**å¾€ä¸‹æ»¾å‹•ï¼Œé»æ“Šç¶ è‰²æŒ‰éˆ•**ï¼š
- **ã€ŒCommit changesã€**

---

### æ­¥é©Ÿ 5ï¼šç¢ºèª Secrets

**é»æ“Šé€™å€‹é€£çµ**ï¼š
```
https://github.com/coingate-cmyk/clinicaltrialvghtpe/settings/secrets/actions
```

**ç¢ºèªæœ‰é€™å…©å€‹**ï¼š
- âœ… `EMAIL_USERNAME`
- âœ… `EMAIL_PASSWORD`

**å¦‚æœæ²’æœ‰ï¼Œè«‹æ–°å¢**ï¼š
1. é»æ“Šã€ŒNew repository secretã€
2. Name: `EMAIL_USERNAME`ï¼ŒValue: `coingate@gmail.com`
3. å†æ–°å¢ä¸€å€‹
4. Name: `EMAIL_PASSWORD`ï¼ŒValue: `ï¼ˆæ‚¨çš„ Gmail App Passwordï¼‰`

---

### æ­¥é©Ÿ 6ï¼šåŸ·è¡Œæ¸¬è©¦

**é»æ“Šé€™å€‹é€£çµ**ï¼š
```
https://github.com/coingate-cmyk/clinicaltrialvghtpe/actions
```

1. é»æ“Šå·¦å´ã€Œéƒµä»¶å‚™ä»½ã€
2. é»æ“Šã€ŒRun workflowã€
3. å†é»ç¶ è‰²çš„ã€ŒRun workflowã€
4. ç­‰å¾… 2 åˆ†é˜
5. **æ‡‰è©²æœƒæˆåŠŸï¼** âœ…

---

## âœ… æˆåŠŸçš„æ¨™èªŒ

### å¦‚æœæˆåŠŸï¼Œæ‚¨æœƒçœ‹åˆ°ï¼š

**åœ¨ GitHub Actions**ï¼š
- âœ… ç¶ è‰²å‹¾å‹¾ï¼ˆä¸æ˜¯ç´…è‰²å‰å‰ï¼‰
- âœ… æ‰€æœ‰æ­¥é©Ÿéƒ½å®Œæˆ
- âœ… **æ²’æœ‰ã€Œæäº¤å‚™ä»½ã€æ­¥é©Ÿ**ï¼ˆå› ç‚ºæ–°ç‰ˆæœ¬ä¸éœ€è¦ï¼‰

**åœ¨ Gmail**ï¼š
- âœ… æ”¶åˆ°éƒµä»¶
- âœ… ä¸»æ—¨ï¼šã€Œè‡¨åºŠè©¦é©—å‚™ä»½ 2026-02-12ã€
- âœ… é™„ä»¶ï¼šExcel æª”æ¡ˆ

---

## ğŸ” é€™å€‹ç‰ˆæœ¬å’Œä¹‹å‰çš„å·®ç•°

### èˆŠç‰ˆæœ¬ï¼ˆä¸€ç›´å¤±æ•—çš„ï¼‰ï¼š
```
ç”Ÿæˆå‚™ä»½ â†’ å­˜åˆ° GitHub âŒ å¤±æ•— â†’ ç™¼éƒµä»¶
```

### æ–°ç‰ˆæœ¬ï¼ˆè¶…ç°¡åŒ–ï¼‰ï¼š
```
ç”Ÿæˆå‚™ä»½ â†’ ç™¼éƒµä»¶ âœ… æˆåŠŸ
