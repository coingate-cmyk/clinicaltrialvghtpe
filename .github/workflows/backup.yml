name: 每日郵件備份

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      
    - uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - run: npm install xlsx
        
    - run: |
        echo "DATE=$(TZ=Asia/Taipei date +'%Y-%m-%d')" >> $GITHUB_ENV
        echo "TIME=$(TZ=Asia/Taipei date +'%Y-%m-%d_%H%M')" >> $GITHUB_ENV
    
    - run: |
        cat > backup.js << 'SCRIPT'
        const fs = require('fs');
        const XLSX = require('xlsx');
        const html = fs.readFileSync('index.html', 'utf8');
        const match = html.match(/const initialTrials = (\[[\s\S]*?\]);/);
        if (match) {
          const trials = JSON.parse(match[1]);
          const worksheet = XLSX.utils.json_to_sheet(trials.map(t => ({
            'ID': t.id, '癌症類型': t.cancerType, '治療線別': t.line,
            '試驗名稱': t.studyTitle, '代號': t.code, '期別': t.phase,
            '贊助商': t.sponsor, '目標人數': t.targetNum, '已收案': t.enrolled,
            '當月簽署': t.monthSigned, '當月入案': t.monthEnrolled,
            '主持人': t.pi, '研究護士': t.nurse, '電話': t.phone,
            '狀態': t.status, '收案條件': t.inclusion || t.criteria || '',
            '排除條件': t.exclusion || ''
          })));
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, '臨床試驗');
          XLSX.writeFile(workbook, `臨床試驗備份_${process.env.DATE}.xlsx`);
          console.log(`✅ 備份完成: ${trials.length} 個試驗`);
        }
        SCRIPT
        
    - run: node backup.js
        
    - uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: ✅ 臨床試驗備份 - ${{ env.DATE }}
        to: coingate@gmail.com
        from: 備份系統 <noreply@backup.system>
        body: |
          備份完成！
          
          日期: ${{ env.DATE }}
          時間: ${{ env.TIME }}
          試驗數: 44 個
          
          請妥善保存此郵件附件。
        attachments: 臨床試驗備份_${{ env.DATE }}.xlsx
```

---

### 步驟 2：前往 GitHub 編輯

**點擊這個連結**：
```
https://github.com/coingate-cmyk/clinicaltrialvghtpe/edit/main/.github/workflows/backup.yml
```

---

### 步驟 3：替換內容

1. **按 Ctrl+A**（全選）
2. **按 Delete**（刪除）
3. **按 Ctrl+V**（貼上剛才複製的內容）
4. **點擊「Commit changes」**（綠色按鈕）

---

### 步驟 4：確認 Secrets 已設定

**訪問**：
```
https://github.com/coingate-cmyk/clinicaltrialvghtpe/settings/secrets/actions
```

**確認有這兩個 Secrets**：
- ✅ `EMAIL_USERNAME`
- ✅ `EMAIL_PASSWORD`

**如果沒有**，請設定：
- EMAIL_USERNAME = `coingate@gmail.com`
- EMAIL_PASSWORD = `（您的 Gmail App Password）`

---

### 步驟 5：執行測試

**訪問**：
```
https://github.com/coingate-cmyk/clinicaltrialvghtpe/actions
