name: backup

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - run: npm install xlsx
        
      - run: echo "DATE=$(TZ=Asia/Taipei date +'%Y-%m-%d')" >> $GITHUB_ENV
        
      - run: |
          cat > backup.js << 'SCRIPTEND'
          const fs = require('fs');
          const XLSX = require('xlsx');
          const html = fs.readFileSync('index.html', 'utf8');
          const match = html.match(/const initialTrials = (\[[\s\S]*?\]);/);
          if (match) {
            const trials = JSON.parse(match[1]);
            const ws = XLSX.utils.json_to_sheet(trials.map(t => ({
              ID: t.id,
              Type: t.cancerType,
              Title: t.studyTitle,
              Code: t.code,
              Phase: t.phase,
              Sponsor: t.sponsor,
              Target: t.targetNum,
              Enrolled: t.enrolled,
              PI: t.pi,
              Nurse: t.nurse,
              Phone: t.phone,
              Status: t.status
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Trials');
            XLSX.writeFile(wb, 'backup.xlsx');
          }
          SCRIPTEND
          
      - run: node backup.js
        
      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: Backup ${{ env.DATE }}
          to: coingate@gmail.com
          from: backup@system.local
          body: Done
          attachments: backup.xlsx
