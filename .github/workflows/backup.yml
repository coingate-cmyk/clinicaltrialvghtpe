name: éƒµä»¶å‚™ä»½

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install xlsx
        
      - name: Set date
        run: echo "DATE=$(TZ=Asia/Taipei date +'%Y-%m-%d')" >> $GITHUB_ENV
        
      - name: Create backup script
        run: |
          cat > backup.js << 'ENDOFFILE'
          const fs = require('fs');
          const XLSX = require('xlsx');
          const html = fs.readFileSync('index.html', 'utf8');
          const match = html.match(/const initialTrials = (\[[\s\S]*?\]);/);
          if (match) {
            const trials = JSON.parse(match[1]);
            const worksheet = XLSX.utils.json_to_sheet(trials.map(t => ({
              'ID': t.id,
              'ç™Œç—‡é¡å‹': t.cancerType,
              'è©¦é©—åç¨±': t.studyTitle,
              'ä»£è™Ÿ': t.code,
              'æœŸåˆ¥': t.phase,
              'è´ŠåŠ©å•†': t.sponsor,
              'ç›®æ¨™äººæ•¸': t.targetNum,
              'å·²æ”¶æ¡ˆ': t.enrolled,
              'ä¸»æŒäºº': t.pi,
              'ç ”ç©¶è­·å£«': t.nurse,
              'é›»è©±': t.phone,
              'ç‹€æ…‹': t.status,
              'æ”¶æ¡ˆæ¢ä»¶': t.inclusion || t.criteria || '',
              'æ’é™¤æ¢ä»¶': t.exclusion || ''
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'è‡¨åºŠè©¦é©—');
            XLSX.writeFile(workbook, 'backup.xlsx');
            console.log('Backup created');
          }
          ENDOFFILE
          
      - name: Run backup
        run: node backup.js
        
      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: è‡¨åºŠè©¦é©—å‚™ä»½ ${{ env.DATE }}
          to: coingate@gmail.com
          from: Backup System <backup@system.local>
          body: å‚™ä»½å®Œæˆ
          attachments: backup.xlsx
```

---

## âœ… æäº¤å¾Œæ‡‰è©²æœƒæˆåŠŸ

**é€™å€‹ç‰ˆæœ¬**ï¼š
- âœ… æ­£ç¢ºçš„ YAML æ ¼å¼
- âœ… æ­£ç¢ºçš„ç¸®æ’
- âœ… æ²’æœ‰ Git æ“ä½œ
- âœ… åªç”Ÿæˆ Excel + ç™¼éƒµä»¶

---

## ğŸ¯ ç¢ºèª Secrets

**è¨ªå•**ï¼š
```
https://github.com/coingate-cmyk/clinicaltrialvghtpe/settings/secrets/actions
